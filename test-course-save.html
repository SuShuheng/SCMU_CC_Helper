<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCMUé€‰è¯¾åŠ©æ‰‹æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .test-button.primary { background: #007bff; color: white; }
        .test-button.success { background: #28a745; color: white; }
        .test-button.warning { background: #ffc107; color: black; }
        .test-button.danger { background: #dc3545; color: white; }

        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .status-display {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .status-display.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status-display.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status-display.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>SCMUé€‰è¯¾åŠ©æ‰‹ - è¯¾ç¨‹ä¿¡æ¯ä¿å­˜æµ‹è¯•</h1>

    <div class="test-container">
        <h2>è¯¾ç¨‹ä¿¡æ¯æµ‹è¯•åŠŸèƒ½</h2>

        <div class="status-display info" id="status-display">
            å‡†å¤‡è¿›è¡Œæµ‹è¯•...
        </div>

        <div style="margin: 15px 0;">
            <button class="test-button primary" onclick="testCourseInfoSaving()">æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯ä¿å­˜</button>
            <button class="test-button success" onclick="testCourseInfoLoading()">æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯åŠ è½½</button>
            <button class="test-button warning" onclick="testDataTypeMapping()">æµ‹è¯•æ•°æ®ç±»å‹æ˜ å°„</button>
            <button class="test-button danger" onclick="clearTestData()">æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
        </div>

        <div style="margin: 15px 0;">
            <h3>æ¨¡æ‹Ÿè¯¾ç¨‹æ“ä½œï¼š</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <label>è¯¾ç¨‹IDï¼š</label>
                <input type="text" id="test-course-id" value="TEST001" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                <label>è¯¾ç¨‹åç§°ï¼š</label>
                <input type="text" id="test-course-name" value="æµ‹è¯•è¯¾ç¨‹" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                <label>è¯¾ç¨‹ç±»å‹ï¼š</label>
                <select id="test-course-type" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                    <option value="TJXK">æ¨èé€‰è¯¾</option>
                    <option value="BFAK">æ–¹æ¡ˆå†…é€‰è¯¾</option>
                    <option value="KZYXK">æ–¹æ¡ˆå¤–é€‰è¯¾</option>
                    <option value="CXXK">é‡ä¿®é€‰è¯¾</option>
                    <option value="TYKXK">ä½“è‚²é€‰æ‹©è¯¾</option>
                    <option value="QXGXK">é€šè¯†è¯¾ç¨‹é€‰ä¿®</option>
                    <option value="CXCY">åˆ›æ–°åˆ›ä¸šç±»é€‰ä¿®è¯¾</option>
                </select>
            </div>

            <button class="test-button primary" onclick="addTestCourse()">æ·»åŠ æµ‹è¯•è¯¾ç¨‹</button>
            <button class="test-button warning" onclick="updateTestCourse()">æ›´æ–°è¯¾ç¨‹ä¿¡æ¯</button>
        </div>

        <h3>æµ‹è¯•æ—¥å¿—ï¼š</h3>
        <div class="log-container" id="log-container"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸGM_setValueå’ŒGM_getValueï¼ˆç”¨äºæµ‹è¯•ç¯å¢ƒï¼‰
        if (typeof GM_setValue === 'undefined') {
            window.GM_setValue = function(key, value) {
                localStorage.setItem('test_' + key, value);
                log('GM_setValue: ' + key + ' = ' + value);
            };

            window.GM_getValue = function(key, defaultValue) {
                const value = localStorage.getItem('test_' + key);
                const result = value !== null ? value : defaultValue;
                log('GM_getValue: ' + key + ' = ' + result);
                return result;
            };

            window.GM_deleteValue = function(key) {
                localStorage.removeItem('test_' + key);
                log('GM_deleteValue: ' + key);
            };
        }

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDisplay = document.getElementById('status-display');
            statusDisplay.textContent = message;
            statusDisplay.className = `status-display ${type}`;
        }

        // æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯ä¿å­˜åŠŸèƒ½
        function testCourseInfoSaving() {
            log('=== å¼€å§‹æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯ä¿å­˜åŠŸèƒ½ ===');

            try {
                // æ¨¡æ‹Ÿè¯¾ç¨‹ç®¡ç†å™¨æ•°æ®
                const testCourses = ['TEST001', 'TEST002'];
                const testExperimentalClasses = { 'TEST001': ['EXP001', 'EXP002'] };
                const testStatusMap = {
                    'TEST001': { success: false, glReady: true },
                    'TEST002': { success: false, glReady: false }
                };
                const testCourseTypeMap = {
                    'TEST001': 'BFAK', // æ–¹æ¡ˆå†…é€‰è¯¾
                    'TEST002': 'QXGXK' // é€šè¯†è¯¾ç¨‹é€‰ä¿®
                };
                const testCourseNameMap = {
                    'TEST001': 'é«˜ç­‰æ•°å­¦ï¼ˆé‡ç‚¹æµ‹è¯•è¯¾ç¨‹ï¼‰',
                    'TEST002': 'å¤§å­¦è‹±è¯­å››å…­çº§'
                };

                // åˆ›å»ºLocalDataManagerå®ä¾‹å¹¶æµ‹è¯•ä¿å­˜
                const localDataManager = new LocalDataManager();

                log('ä¿å­˜è¯¾ç¨‹æ•°æ®ï¼ˆåŒ…å«è¯¾ç¨‹åç§°ï¼‰...');
                const saveResult = localDataManager.saveCoursesData(
                    testCourses,
                    testExperimentalClasses,
                    testStatusMap,
                    testCourseTypeMap,
                    testCourseNameMap // ç°åœ¨ä¼ é€’è¯¾ç¨‹åç§°æ˜ å°„
                );

                if (saveResult) {
                    log('âœ… è¯¾ç¨‹ä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
                    updateStatus('è¯¾ç¨‹ä¿¡æ¯ä¿å­˜æˆåŠŸ', 'success');

                    // éªŒè¯ä¿å­˜çš„æ•°æ®
                    const savedData = localStorage.getItem('test_scmu_courses');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        log('ä¿å­˜çš„è¯¾ç¨‹æ•°æ®ï¼š' + JSON.stringify(parsedData, null, 2));

                        // æ£€æŸ¥è¯¾ç¨‹ç±»å‹å’Œåç§°æ˜¯å¦æ­£ç¡®ä¿å­˜
                        const test1Course = parsedData.find(c => c.id === 'TEST001');
                        const test2Course = parsedData.find(c => c.id === 'TEST002');

                        // éªŒè¯TEST001
                        if (test1Course) {
                            if (test1Course.courseType === 'BFAK') {
                                log('âœ… TEST001 è¯¾ç¨‹ç±»å‹æ­£ç¡®ä¿å­˜ï¼š' + test1Course.courseType);
                            } else {
                                log('âŒ TEST001 è¯¾ç¨‹ç±»å‹ä¿å­˜å¤±è´¥ï¼ŒæœŸæœ›ï¼šBFAKï¼Œå®é™…ï¼š' + test1Course.courseType);
                            }

                            if (test1Course.name === 'é«˜ç­‰æ•°å­¦ï¼ˆé‡ç‚¹æµ‹è¯•è¯¾ç¨‹ï¼‰') {
                                log('âœ… TEST001 è¯¾ç¨‹åç§°æ­£ç¡®ä¿å­˜ï¼š' + test1Course.name);
                            } else {
                                log('âŒ TEST001 è¯¾ç¨‹åç§°ä¿å­˜å¤±è´¥ï¼ŒæœŸæœ›ï¼šé«˜ç­‰æ•°å­¦ï¼ˆé‡ç‚¹æµ‹è¯•è¯¾ç¨‹ï¼‰ï¼Œå®é™…ï¼š' + test1Course.name);
                            }
                        } else {
                            log('âŒ TEST001 è¯¾ç¨‹æ•°æ®æœªæ‰¾åˆ°');
                        }

                        // éªŒè¯TEST002
                        if (test2Course) {
                            if (test2Course.courseType === 'QXGXK') {
                                log('âœ… TEST002 è¯¾ç¨‹ç±»å‹æ­£ç¡®ä¿å­˜ï¼š' + test2Course.courseType);
                            } else {
                                log('âŒ TEST002 è¯¾ç¨‹ç±»å‹ä¿å­˜å¤±è´¥ï¼ŒæœŸæœ›ï¼šQXGXKï¼Œå®é™…ï¼š' + test2Course.courseType);
                            }

                            if (test2Course.name === 'å¤§å­¦è‹±è¯­å››å…­çº§') {
                                log('âœ… TEST002 è¯¾ç¨‹åç§°æ­£ç¡®ä¿å­˜ï¼š' + test2Course.name);
                            } else {
                                log('âŒ TEST002 è¯¾ç¨‹åç§°ä¿å­˜å¤±è´¥ï¼ŒæœŸæœ›ï¼šå¤§å­¦è‹±è¯­å››å…­çº§ï¼Œå®é™…ï¼š' + test2Course.name);
                            }
                        } else {
                            log('âŒ TEST002 è¯¾ç¨‹æ•°æ®æœªæ‰¾åˆ°');
                        }
                    }
                } else {
                    log('âŒ è¯¾ç¨‹ä¿¡æ¯ä¿å­˜å¤±è´¥ï¼');
                    updateStatus('è¯¾ç¨‹ä¿¡æ¯ä¿å­˜å¤±è´¥', 'error');
                }

            } catch (error) {
                log('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š' + error.message);
                updateStatus('æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯åŠ è½½åŠŸèƒ½
        function testCourseInfoLoading() {
            log('=== å¼€å§‹æµ‹è¯•è¯¾ç¨‹ä¿¡æ¯åŠ è½½åŠŸèƒ½ ===');

            try {
                const localDataManager = new LocalDataManager();

                log('åŠ è½½è¯¾ç¨‹æ•°æ®...');
                const loadedData = localDataManager.loadCoursesData();

                if (loadedData && loadedData.courses.length > 0) {
                    log('âœ… è¯¾ç¨‹ä¿¡æ¯åŠ è½½æˆåŠŸï¼');
                    log('åŠ è½½çš„è¯¾ç¨‹æ•°é‡ï¼š' + loadedData.courses.length);

                    loadedData.courses.forEach((course, index) => {
                        log(`è¯¾ç¨‹ ${index + 1}: ID=${course.id}, ç±»å‹=${course.courseType}, åç§°=${course.name}`);
                    });

                    updateStatus('è¯¾ç¨‹ä¿¡æ¯åŠ è½½æˆåŠŸï¼Œå…± ' + loadedData.courses.length + ' é—¨è¯¾ç¨‹', 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è¯¾ç¨‹æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œä¿å­˜æµ‹è¯•');
                    updateStatus('æ²¡æœ‰æ‰¾åˆ°è¯¾ç¨‹æ•°æ®ï¼Œè¯·å…ˆä¿å­˜æµ‹è¯•è¯¾ç¨‹', 'error');
                }

            } catch (error) {
                log('âŒ åŠ è½½æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š' + error.message);
                updateStatus('åŠ è½½æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®ç±»å‹æ˜ å°„
        function testDataTypeMapping() {
            log('=== å¼€å§‹æµ‹è¯•æ•°æ®ç±»å‹æ˜ å°„ ===');

            try {
                // æ¨¡æ‹Ÿå®Œæ•´çš„é€‰è¯¾åŠ©æ‰‹ç¯å¢ƒ
                log('æ¨¡æ‹Ÿæ•°æ®ä¿å­˜å’Œåˆ·æ–°åçš„åŠ è½½è¿‡ç¨‹...');

                // 1. æ¨¡æ‹Ÿä¿å­˜æ•°æ®
                const testData = [
                    { id: 'COURSE001', name: 'é«˜ç­‰æ•°å­¦', courseType: 'BFAK', addedTime: Date.now(), status: { success: false } },
                    { id: 'COURSE002', name: 'å¤§å­¦è‹±è¯­', courseType: 'TYKXK', addedTime: Date.now(), status: { success: false } },
                    { id: 'COURSE003', name: 'è®¡ç®—æœºåŸºç¡€', courseType: 'QXGXK', addedTime: Date.now(), status: { success: false } }
                ];

                localStorage.setItem('test_scmu_courses', JSON.stringify(testData));
                log('ä¿å­˜äº†3é—¨ä¸åŒç±»å‹çš„æµ‹è¯•è¯¾ç¨‹');

                // 2. æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åçš„æ•°æ®åŠ è½½
                const loadedCourses = JSON.parse(localStorage.getItem('test_scmu_courses'));
                log('é¡µé¢åˆ·æ–°ååŠ è½½è¯¾ç¨‹æ•°æ®ï¼š');

                loadedCourses.forEach((course, index) => {
                    log(`  ${index + 1}. ${course.name} (${course.id}) - ${course.courseType}`);
                });

                // 3. éªŒè¯è¯¾ç¨‹ç±»å‹æ¢å¤
                const courseTypes = loadedCourses.map(c => c.courseType);
                const expectedTypes = ['BFAK', 'TYKXK', 'QXGXK'];

                const isCorrect = courseTypes.every((type, index) => type === expectedTypes[index]);

                if (isCorrect) {
                    log('âœ… è¯¾ç¨‹ç±»å‹æ˜ å°„å®Œå…¨æ­£ç¡®ï¼');
                    updateStatus('æ•°æ®ç±»å‹æ˜ å°„æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    log('âŒ è¯¾ç¨‹ç±»å‹æ˜ å°„é”™è¯¯ï¼æœŸæœ›ï¼š' + expectedTypes.join(', ') + 'ï¼Œå®é™…ï¼š' + courseTypes.join(', '));
                    updateStatus('æ•°æ®ç±»å‹æ˜ å°„æµ‹è¯•å¤±è´¥', 'error');
                }

            } catch (error) {
                log('âŒ ç±»å‹æ˜ å°„æµ‹è¯•å¤±è´¥ï¼š' + error.message);
                updateStatus('ç±»å‹æ˜ å°„æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ·»åŠ æµ‹è¯•è¯¾ç¨‹
        function addTestCourse() {
            const courseId = document.getElementById('test-course-id').value;
            const courseName = document.getElementById('test-course-name').value;
            const courseType = document.getElementById('test-course-type').value;

            log(`æ·»åŠ æµ‹è¯•è¯¾ç¨‹ï¼š${courseId} - ${courseName} (${courseType})`);

            try {
                // æ¨¡æ‹Ÿæ·»åŠ è¯¾ç¨‹é€»è¾‘
                const existingData = localStorage.getItem('test_scmu_courses');
                let courses = existingData ? JSON.parse(existingData) : [];

                // æ£€æŸ¥è¯¾ç¨‹æ˜¯å¦å·²å­˜åœ¨
                if (courses.find(c => c.id === courseId)) {
                    log('âš ï¸ è¯¾ç¨‹å·²å­˜åœ¨ï¼Œå°†æ›´æ–°è¯¾ç¨‹ä¿¡æ¯');
                    const course = courses.find(c => c.id === courseId);
                    course.name = courseName;
                    course.courseType = courseType;
                    course.status = { success: false };
                } else {
                    // æ·»åŠ æ–°è¯¾ç¨‹
                    courses.push({
                        id: courseId,
                        name: courseName,
                        courseType: courseType,
                        addedTime: Date.now(),
                        status: { success: false }
                    });
                    log('âœ… æ–°è¯¾ç¨‹æ·»åŠ æˆåŠŸ');
                }

                localStorage.setItem('test_scmu_courses', JSON.stringify(courses));
                log('ğŸ’¾ è¯¾ç¨‹ä¿¡æ¯å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');

                updateStatus(`è¯¾ç¨‹ "${courseName}" æ·»åŠ /æ›´æ–°æˆåŠŸ`, 'success');

            } catch (error) {
                log('âŒ æ·»åŠ è¯¾ç¨‹å¤±è´¥ï¼š' + error.message);
                updateStatus('æ·»åŠ è¯¾ç¨‹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ›´æ–°æµ‹è¯•è¯¾ç¨‹
        function updateTestCourse() {
            const courseId = document.getElementById('test-course-id').value;
            const courseName = document.getElementById('test-course-name').value;
            const courseType = document.getElementById('test-course-type').value;

            log(`æ›´æ–°æµ‹è¯•è¯¾ç¨‹ï¼š${courseId} - ${courseName} (${courseType})`);

            try {
                const existingData = localStorage.getItem('test_scmu_courses');
                if (!existingData) {
                    log('âŒ æ²¡æœ‰æ‰¾åˆ°è¯¾ç¨‹æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è¯¾ç¨‹');
                    updateStatus('æ²¡æœ‰æ‰¾åˆ°è¯¾ç¨‹æ•°æ®', 'error');
                    return;
                }

                const courses = JSON.parse(existingData);
                const course = courses.find(c => c.id === courseId);

                if (!course) {
                    log('âŒ è¯¾ç¨‹ä¸å­˜åœ¨ï¼š' + courseId);
                    updateStatus('è¯¾ç¨‹ä¸å­˜åœ¨', 'error');
                    return;
                }

                // æ›´æ–°è¯¾ç¨‹ä¿¡æ¯
                const oldName = course.name;
                const oldType = course.courseType;

                course.name = courseName;
                course.courseType = courseType;

                localStorage.setItem('test_scmu_courses', JSON.stringify(courses));

                log(`âœ… è¯¾ç¨‹ä¿¡æ¯æ›´æ–°æˆåŠŸï¼š`);
                log(`  åç§°ï¼š${oldName} â†’ ${courseName}`);
                log(`  ç±»å‹ï¼š${oldType} â†’ ${courseType}`);

                updateStatus(`è¯¾ç¨‹ä¿¡æ¯æ›´æ–°æˆåŠŸ`, 'success');

            } catch (error) {
                log('âŒ æ›´æ–°è¯¾ç¨‹å¤±è´¥ï¼š' + error.message);
                updateStatus('æ›´æ–°è¯¾ç¨‹å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæµ‹è¯•æ•°æ®
        function clearTestData() {
            log('=== æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ® ===');

            const keys = ['test_scmu_courses', 'test_scmu_experimental_classes', 'test_scmu_metadata'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                log('å·²åˆ é™¤ï¼š' + key);
            });

            log('âœ… æ‰€æœ‰æµ‹è¯•æ•°æ®å·²æ¸…ç©º');
            updateStatus('æµ‹è¯•æ•°æ®å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('SCMUé€‰è¯¾åŠ©æ‰‹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('æç¤ºï¼šè¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æŸ¥çœ‹æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯');
            updateStatus('æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª', 'info');
        };
    </script>

    <!-- è¿™é‡Œéœ€è¦åŒ…å«å®é™…çš„é€‰è¯¾åŠ©æ‰‹ä»£ç è¿›è¡Œæµ‹è¯• -->
    <script>
        // æ¨¡æ‹ŸLocalDataManagerç±»çš„å®šä¹‰ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äºæµ‹è¯•ï¼‰
        class LocalDataManager {
            constructor() {
                this.STORAGE_KEYS = {
                    COURSES: 'scmu_courses',
                    EXPERIMENTAL_CLASSES: 'scmu_experimental_classes',
                    METADATA: 'scmu_metadata'
                };
                this.DATA_VERSION = '2.0.0';
                this.storageAvailable = this.checkStorageAvailability();
                this.DEFAULT_COURSE_NAME = 'è¯·è¾“å…¥åç§°(å¯é€‰)';
            }

            checkStorageAvailability() {
                try {
                    return typeof GM_setValue !== 'undefined' && typeof GM_getValue !== 'undefined';
                } catch (e) {
                    console.error(`å­˜å‚¨åŠŸèƒ½æ£€æµ‹å¤±è´¥:`, e);
                    return false;
                }
            }

            saveCoursesData(courses, experimentalClasses, statusMap, courseTypeMap = {}, courseNameMap = {}) {
                if (!this.storageAvailable) {
                    console.warn(`å­˜å‚¨åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ•°æ®æ— æ³•ä¿å­˜`);
                    return false;
                }

                try {
                    // æ•°æ®éªŒè¯
                    if (!Array.isArray(courses)) {
                        console.error(`è¯¾ç¨‹æ•°æ®æ ¼å¼é”™è¯¯ï¼ŒæœŸæœ›æ•°ç»„æ ¼å¼`);
                        return false;
                    }

                    // è¿‡æ»¤æ— æ•ˆè¯¾ç¨‹ID
                    const validCourses = courses.filter(courseId =>
                        courseId && typeof courseId === 'string' && courseId.trim().length > 0
                    );

                    if (validCourses.length === 0) {
                        console.log(`æ²¡æœ‰æœ‰æ•ˆçš„è¯¾ç¨‹æ•°æ®éœ€è¦ä¿å­˜`);
                        return true;
                    }

                    // è·å–ç°æœ‰æ•°æ®ä»¥ä¿ç•™è¯¾ç¨‹åç§°ç­‰ä¿¡æ¯
                    const existingDataStr = GM_getValue(this.STORAGE_KEYS.COURSES, '[]');
                    let existingCourses = [];
                    try {
                        existingCourses = JSON.parse(existingDataStr);
                    } catch (e) {
                        console.warn(`è¯»å–ç°æœ‰è¯¾ç¨‹æ•°æ®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®`);
                    }

                    // åˆå¹¶æ•°æ®ï¼Œä¿ç•™å·²å­˜åœ¨çš„è¯¾ç¨‹ä¿¡æ¯ã€è¯¾ç¨‹ç±»å‹å’Œè¯¾ç¨‹åç§°
                    const mergedCourses = validCourses.map(courseId => {
                        const existing = existingCourses.find(c => c.id === courseId);
                        const courseName = courseNameMap[courseId] || existing?.name || this.DEFAULT_COURSE_NAME;
                        const courseType = courseTypeMap[courseId] || existing?.courseType || 'KZYXK';

                        console.log(`åˆå¹¶è¯¾ç¨‹æ•°æ®: ${courseId}, åç§°: "${courseName}", ç±»å‹: ${courseType}`);

                        return {
                            id: courseId,
                            name: courseName, // ä¼˜å…ˆä½¿ç”¨courseNameMapä¸­çš„åç§°
                            courseType: courseType,
                            addedTime: existing?.addedTime || Date.now(),
                            nameUpdatedTime: courseNameMap[courseId] ? Date.now() : existing?.nameUpdatedTime, // è®°å½•åç§°æ›´æ–°æ—¶é—´
                            status: {
                                success: statusMap[courseId]?.success || existing?.status?.success || false
                            }
                        };
                    });

                    const storageData = {
                        courses: mergedCourses,
                        experimentalClasses: experimentalClasses || {},
                        metadata: {
                            lastSaved: Date.now(),
                            version: this.DATA_VERSION,
                            sessionCount: this.getSessionCount() + 1,
                            coursesCount: mergedCourses.length
                        }
                    };

                    // ä¿å­˜æ•°æ®
                    GM_setValue(this.STORAGE_KEYS.COURSES, JSON.stringify(storageData.courses));
                    GM_setValue(this.STORAGE_KEYS.EXPERIMENTAL_CLASSES, JSON.stringify(storageData.experimentalClasses));
                    GM_setValue(this.STORAGE_KEYS.METADATA, JSON.stringify(storageData.metadata));

                    console.log(`æ•°æ®ä¿å­˜æˆåŠŸï¼Œå…±${storageData.courses.length}é—¨è¯¾ç¨‹`);
                    console.log(`è¯¾ç¨‹ä¿¡æ¯å·²ä¿å­˜:`, mergedCourses.map(c => ({
                        id: c.id,
                        name: c.name,
                        type: c.courseType,
                        nameUpdated: c.nameUpdatedTime ? new Date(c.nameUpdatedTime).toLocaleTimeString() : 'æœªæ›´æ–°'
                    })));
                    return true;
                } catch (error) {
                    console.error(`ä¿å­˜æ•°æ®å¤±è´¥:`, error);
                    return false;
                }
            }

            loadCoursesData() {
                if (!this.storageAvailable) {
                    console.warn(`æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½æ•°æ®`);
                    return null;
                }

                try {
                    const coursesStr = GM_getValue(this.STORAGE_KEYS.COURSES, '[]');
                    const experimentalClassesStr = GM_getValue(this.STORAGE_KEYS.EXPERIMENTAL_CLASSES, '{}');
                    const metadataStr = GM_getValue(this.STORAGE_KEYS.METADATA, '{}');

                    const courses = JSON.parse(coursesStr);
                    const experimentalClasses = JSON.parse(experimentalClassesStr);
                    const metadata = JSON.parse(metadataStr);

                    console.log(`ä»æœ¬åœ°å­˜å‚¨è¯»å–åˆ° ${courses.length} é—¨è¯¾ç¨‹æ•°æ®`);

                    if (courses.length === 0) {
                        console.log(`æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰è¯¾ç¨‹æ•°æ®`);
                        return null;
                    }

                    const result = {
                        courses: courses, // ç›´æ¥è¿”å›å®Œæ•´çš„è¯¾ç¨‹å¯¹è±¡æ•°ç»„ï¼ŒåŒ…å«courseTypeç­‰ä¿¡æ¯
                        courseDetails: courses,
                        experimentalClasses,
                        metadata: metadata
                    };

                    console.log(`æ•°æ®åŠ è½½å®Œæˆ:`, result);
                    return result;
                } catch (error) {
                    console.error(`åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥:`, error);
                    // æ¸…ç†æŸåçš„æ•°æ®
                    try {
                        GM_deleteValue(this.STORAGE_KEYS.COURSES);
                        GM_deleteValue(this.STORAGE_KEYS.EXPERIMENTAL_CLASSES);
                        GM_deleteValue(this.STORAGE_KEYS.METADATA);
                        console.log(`å·²æ¸…ç†æŸåçš„æœ¬åœ°å­˜å‚¨æ•°æ®`);
                    } catch (clearError) {
                        console.error(`æ¸…ç†æ•°æ®å¤±è´¥:`, clearError);
                    }
                    return null;
                }
            }

            getSessionCount() {
                try {
                    const metadata = JSON.parse(GM_getValue(this.STORAGE_KEYS.METADATA, '{}'));
                    return metadata.sessionCount || 0;
                } catch (e) {
                    return 0;
                }
            }
        }
    </script>
</body>
</html>