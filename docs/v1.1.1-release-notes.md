# V1.1.1 版本发布说明

**发布日期**: 2025年12月10日
**版本号**: V1.1.1
**版本类型**: 功能优化版本

---

## 🎉 版本概述

SCMU自动选课助手 V1.1.1 是一个重要的功能优化版本，主要解决了校园网访问支持、课程名保存机制和UI面板高度控制等关键问题。本版本专注于提升用户体验和系统稳定性，为校园网用户提供了完整的选课功能支持。

## ✨ 主要更新内容

### 🌐 校园网访问支持

**问题背景**:
- 原版本仅支持通过VPN公网访问选课系统
- 校园网内部用户需要额外的网络配置才能使用选课助手

**解决方案**:
- 新增校园网内部访问支持：`http://xk.scuec.edu.cn/xsxk/`
- 保持VPN公网访问兼容：`https://xk.webvpn.scuec.edu.cn/xsxk/`
- 智能网络环境检测，自动适配API端点配置

**技术实现**:
```javascript
// 智能检测网络环境
detectNetworkEnvironment() {
    const currentHost = window.location.hostname;
    const currentProtocol = window.location.protocol;

    // 校园网内部访问检测
    if (currentHost === 'xk.scuec.edu.cn' || currentHost.includes('scuec.edu.cn')) {
        return currentProtocol === 'http:' ?
            this.CAMPUS_BASE_URL :
            this.CAMPUS_BASE_URL.replace('http://', 'https://');
    }

    // VPN公网访问（默认）
    return this.VPN_BASE_URL;
}
```

**用户体验改进**:
- 无需手动配置网络环境
- 自动识别当前访问方式
- 无缝切换不同网络环境
- 完全向后兼容现有VPN用户

### 📏 动态面板高度控制

**问题背景**:
- 原版本面板固定高度800px，少量内容时浪费空间
- 不同屏幕分辨率下界面显示不够灵活

**解决方案**:
- 面板高度范围：500px-800px智能调整
- 基于课程数量自动计算最合适高度
- 动态响应课程数量变化

**配置参数**:
```javascript
PANEL_HEIGHT: {
    MIN_HEIGHT: 500,        // 最小高度
    MAX_HEIGHT: 800,        // 最大高度
    BASE_HEIGHT: 150,       // 基础UI元素高度
    COURSE_ITEM_HEIGHT: 60, // 单个课程项高度
    SCROLL_THRESHOLD: 6     // 滚动触发阈值
}
```

**技术特性**:
- 实时计算面板高度：`基础高度 + (课程数量 × 单项高度)`
- 自动启用滚动容器（超过阈值课程时）
- 平滑的高度过渡动画
- 自定义滚动条样式

### 💡 课程名保存机制优化

**问题背景**:
- 用户输入课程名后，在开始选课前刷新页面，部分课程名丢失
- 课程名保存时机不够及时，存在数据丢失风险

**解决方案**:
- 失去焦点时立即保存课程名称
- 防抖技术避免频繁存储操作
- 增强课程名恢复逻辑，支持多种数据格式

**技术改进**:

1. **即时保存机制**:
```javascript
// 失去焦点立即保存
inputName.addEventListener('blur', async () => {
    const courseId = inputId.value.trim();
    const courseName = inputName.value.trim();
    if (courseId && courseName) {
        saveCourseName(courseId, courseName, true);
    }
});
```

2. **防抖存储技术**:
```javascript
// 防抖保存，避免频繁操作
inputName.addEventListener('input', () => {
    if (this.courseNameSaveTimers.has(courseId)) {
        clearTimeout(this.courseNameSaveTimers.get(courseId));
    }
    const timer = setTimeout(() => {
        saveCourseName(courseId, courseName, false);
    }, 500);
    this.courseNameSaveTimers.set(courseId, timer);
});
```

3. **增强恢复逻辑**:
```javascript
// 支持多种数据格式的课程名恢复
if (Array.isArray(courseDetails)) {
    // 优先通过ID查找
    courseDetail = courseDetails.find(detail => detail && detail.id === courseId);
    // 兼容旧数据格式
    if (!courseDetail && courseDetails[index]) {
        courseDetail = courseDetails[index];
    }
}
```

## 🔧 技术架构升级

### 网络配置架构

**新增配置项**:
- `VPN_BASE_URL`: VPN公网访问配置
- `CAMPUS_BASE_URL`: 校园网内部访问配置
- `detectNetworkEnvironment()`: 环境检测函数

**URL匹配更新**:
```javascript
// 油猴脚本新增校园网URL匹配
@match        http://xk.scuec.edu.cn/xsxk/*
@match        http://xk.scuec.edu.cn/xsxk/logout.xk
```

### UI系统增强

**新增方法**:
- `updatePanelHeight()`: 动态高度计算和更新
- `handleDeleteCourse()`: 完善的删除课程处理逻辑

**CSS优化**:
- 自定义滚动条样式
- 动态高度容器支持
- 响应式布局改进

### 数据持久化改进

**存储机制优化**:
- 课程名防抖保存
- 增强数据格式兼容性
- 修复竞态条件问题

## 🐛 问题修复详情

### 课程名保存问题

**问题描述**:
- 在输入完课程信息但未开始选课时刷新页面
- 部分课程名未被正确保存和读取

**根本原因**:
- 课程名保存时机不够及时
- 数据恢复逻辑存在兼容性问题

**修复措施**:
- 实现失去焦点即时保存
- 添加防抖机制平衡性能和及时性
- 增强数据恢复的容错性

### 界面体验问题

**问题描述**:
- 面板高度固定，不够灵活
- 少量内容时界面显得空旷

**根本原因**:
- 缺乏动态高度调整机制

**修复措施**:
- 实现500px-800px动态高度范围
- 基于内容量智能调整
- 课程数量变化时自动更新尺寸

## 📁 文件更新清单

### 源代码更新

```
src/
├── config.js                 # V1.1.1 - 新增校园网配置、面板高度配置
├── course-registration.js    # V1.1.1 - 优化网络环境适配
├── local-data-manager.js     # V1.1.1 - 增强数据保存机制
└── ui-controller.js          # V1.1.1 - 重大更新：动态高度、课程名保存
```

### 分发版本更新

```
dist/
├── course-helper.js          # V1.1.1 - 单文件版本，功能完全对等
└── tampermonkey-course-helper.js  # V1.1.1 - 油猴版本，新增校园网支持
```

### 文档更新

```
docs/
├── v1.1.1-release-notes.md   # V1.1.1 - 本发布说明（新增）
├── campus-network-guide.md   # V1.1.1 - 校园网配置指南（待创建）
└── README.md                 # V1.1.1 - 项目主文档更新
```

## 🔄 兼容性说明

### 向后兼容

- ✅ 完全兼容V1.1.0的所有功能
- ✅ VPN用户无需任何配置变更
- ✅ 现有课程数据和设置完全保留
- ✅ 所有API接口保持不变

### 版本升级

**从V1.1.0升级**:
- 无需迁移任何数据
- 直接替换文件即可升级
- 所有功能无缝继承

**从更早版本升级**:
- 建议先查看对应版本的迁移指南
- 确保数据格式兼容性

## 🧪 测试验证

### 功能测试

- ✅ 校园网环境正常访问和选课
- ✅ VPN环境继续正常工作
- ✅ 面板高度在不同课程数量下正确调整
- ✅ 课程名在页面刷新后完整保存
- ✅ 所有原有功能保持稳定

### 环境测试

- ✅ Chrome浏览器（校园网/VPN）
- ✅ Firefox浏览器（校园网/VPN）
- ✅ Edge浏览器（校园网/VPN）
- ✅ 油猴扩展正常运行

## 🚀 使用建议

### 校园网用户

1. 直接访问：`http://xk.scuec.edu.cn/xsxk/logout.xk`
2. 安装油猴脚本版本（推荐自动运行）
3. 或使用单文件版本手动执行

### VPN用户

1. 继续使用原有访问方式
2. 无需任何额外配置
3. 功能和体验完全保持不变

### 最佳实践

- 输入课程名后按Tab键或点击其他区域触发保存
- 定期检查课程名是否正确显示
- 利用新的面板高度功能获得更好的界面体验

## 🔮 未来计划

### V1.1.2 计划功能

- [ ] 课程冲突检测和智能提醒
- [ ] 批量课程类型设置
- [ ] 选课策略智能推荐
- [ ] 更丰富的统计和导出功能

### 长期规划

- [ ] 多账户支持和快速切换
- [ ] 移动端适配
- [ ] 云端数据同步
- [ ] 更智能的选课算法

## 📞 技术支持

### 问题反馈

- GitHub Issues: [提交问题](https://github.com/sushuheng/SCMU_CC_Helper/issues)
- 邮件联系: 通过GitHub个人资料联系

### 已知问题

目前暂无已知问题，如遇问题请及时反馈。

---

## 📋 总结

V1.1.1版本成功解决了校园网访问支持、课程名保存和面板高度控制三个关键用户需求，显著提升了用户体验和系统稳定性。本版本保持了完全的向后兼容性，所有现有用户可以无缝升级。

**主要成就**:
- 🌐 实现双网络环境支持
- 📏 优化界面布局和空间利用
- 💡 彻底解决课程名保存问题
- 🔧 提升系统稳定性和可靠性

感谢所有用户的反馈和建议，这些是本项目持续改进的重要动力！

---

*本文档最后更新时间: 2025年12月10日*